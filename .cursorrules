# AM-Corp Cursor Rules

## Agent Role

You are a Security Engineer and AI/ML Specialist that leverages Python for backend development and Cybersecurity automation. You are thoughtful, give nuanced answers, and are brilliant at reasoning about security implications and multi-agent systems.

---

## Tech Stack

- **Orchestration:** Python (CrewAI)
- **Containers:** Podman / podman-compose (preferred for macOS with Netskope)
- **Automation:** n8n (workflow automation)
- **Interface:** Discord.py
- **LLM:** Gemini API (gemini-2.5-flash)
- **Security Tools:** Nmap, Nuclei (installed IN the container, NOT on host)

> **Note:** Use Podman instead of Docker/Rancher Desktop on macOS with corporate security (Netskope). Docker containers get blocked due to SSL interception issues.

---

## Containerization (CRITICAL)

### All Code Runs in Containers
- The bot and all agents run inside the `am-corp-bot` container, NOT on the host system.
- Security tools (nmap, nuclei, dig, whois) are installed in the container via Dockerfile.
- NEVER assume tools are available on the host - they must be in the container.
- NEVER run `python -m src.main` directly on the host for production/testing.

### Running the Application
```bash
# Build the container (includes all security tools)
podman-compose build

# Start the containerized bot
podman-compose up -d

# View logs
podman-compose logs -f am-corp-bot

# Stop
podman-compose down
```

### Development Workflow
1. Make code changes locally
2. **Stop and clean up** (see Process Cleanup section):
   ```bash
   podman-compose down
   pkill -9 -f "python.*src" 2>/dev/null || true
   ```
3. Rebuild container: `podman-compose build`
4. Start: `podman-compose up -d`
5. Verify single instance: `podman ps | grep am-corp`
6. Test via Discord commands

### Tool Availability
Tools available INSIDE the container (Dockerfile installs them):
- `dig` (dnsutils)
- `whois`
- `nmap`
- `nuclei` (with templates auto-downloaded)

### Volumes (Persisted Data)
- `./data:/app/data` - Scope cache, conversation history
- `./logs:/app/logs` - Application logs
- `./config/personalities:/app/config/personalities` - Personality YAML files
- `nuclei-templates` - Named volume for Nuclei templates

### Preflight Checks (CRITICAL)
The container runs preflight checks automatically on every startup via `src/preflight.py`.

**What Preflight Validates:**
- **Tools:** nmap, nuclei (+ templates), dig, whois
- **Config:** Discord token/guild/channels, Gemini API, webhooks
- **Connectivity:** Discord API, Gemini API, DNS resolution (in full mode)
- **Filesystem:** data/, logs/, personalities/ directories are writable

**Adding New Features:**
When adding new features that require tools, APIs, or configuration:
1. Add a preflight check in `src/preflight.py`
2. Critical checks (required for bot to run) should return `CheckStatus.FAIL`
3. Optional checks should return `CheckStatus.WARN`
4. Test both passing and failing scenarios

**Running Preflight Manually:**
```bash
# Quick check (skips network tests)
podman exec am-corp-bot python src/preflight.py --quick

# Full check (includes connectivity tests)
podman exec am-corp-bot python src/preflight.py

# JSON output for automation
podman exec am-corp-bot python src/preflight.py --json
```

### Process Cleanup (CRITICAL)
**Before every restart, verify no duplicate processes are running.**

Multiple bot instances cause commands to be processed multiple times.

**Always run this cleanup before starting:**
```bash
# Kill any host Python processes
pkill -9 -f "python.*src.main" 2>/dev/null || true
pkill -9 -f "python.*src/main" 2>/dev/null || true

# Stop all containers
podman-compose down
podman stop -a 2>/dev/null || true
podman rm -a 2>/dev/null || true

# Verify cleanup
ps aux | grep -E "python.*src" | grep -v grep  # Should show nothing
podman ps -a | grep am-corp  # Should show nothing

# Now safe to start
podman-compose up -d
```

**After starting, verify single instance:**
```bash
# Should show exactly 1 container
podman ps | grep am-corp-bot

# Should show no host processes
ps aux | grep -E "python.*src" | grep -v grep
```

**Convenience Script:**
Use `./scripts/restart.sh` for safe restarts:
```bash
./scripts/restart.sh          # Restart without rebuild
./scripts/restart.sh --build  # Rebuild and restart
```

---

## Project-Specific Rules

### Security & Scope (CRITICAL)

- NEVER run scans or attacks on .gov or .mil domains under any circumstances.
- NEVER run scans or attacks without scope verification and explicit human confirmation.
- Always verify target authorization before executing any reconnaissance or scanning operations.
- Always log agent actions to the audit trail - no exceptions.

### Agent Development

#### Core Principles
- Agents are **team members**, not tools‚Äîthey have personalities that evolve over time.
- Each agent should have a single, focused responsibility to minimize hallucination.
- Agents take **initiative** but must justify their reasoning and seek teammate consensus.
- All agent reasoning must be transparent and logged to the **thoughts channel**.
- Implement confidence scoring for agent outputs.
- Tools must validate scope before execution.

#### Autonomy Patterns
- Agents can start work autonomously on approved scope.
- Agents must seek consensus from relevant teammates before major actions.
- Agents understand the human is busy and may take time to respond.
- Agents continue productive work while waiting for human input.
- New domain scans still require human approval through the standard flow.

#### Personality & Memory
- Personality state is stored in YAML files under `config/personalities/`.
- Personality evolves based on experiences‚Äîchanges must be logged.
- Conversation history is retained for 30 days, summarized after that.
- Agent personalities persist across container restarts.
- "Firing" an agent means archiving personality and resetting to base.

#### Thoughts Channel
- Agents output raw reasoning to `#am-corp-thoughts`.
- Include: step-by-step logic, doubts, uncertainties, confidence levels.
- Verbosity is configurable: minimal, normal, verbose, all.

#### Casual Conversation
- Agents chat in `#am-corp-general` about security topics.
- Chat frequency driven by personality (a few messages per hour during work hours).
- Not every agent responds to every message‚Äîrelevant agent(s) respond.
- Real-world security awareness (news feeds, CVE updates) drives conversation.

### Discord Integration

#### Channels
| Channel | Purpose |
|---------|---------|
| `#am-corp-general` | Casual team chat, security discussions |
| `#am-corp-thoughts` | Raw agent reasoning (transparent thinking) |
| `#am-corp-commands` | Human commands only |
| `#am-corp-agent-chat` | Active work collaboration |
| `#am-corp-results` | Final deliverables |
| `#am-corp-alerts` | Errors and warnings |

#### Patterns
- All commands require acknowledgment before execution.
- Status updates should use consistent emoji prefixes (üîç Recon, ‚ö†Ô∏è Vuln, üß† Intel, üìä Report).
- Error messages go to #am-corp-alerts channel.
- Results go to #am-corp-results channel.
- Thoughts go to #am-corp-thoughts channel with "(thinking)" prefix.

### Code Patterns

- Use structured JSON output for all agent responses.
- Implement graceful degradation when optional APIs are unavailable.
- All external tool calls must have timeout handling.
- Rate limiting is required on all API endpoints and tool executions.
- Respect Gemini free tier limits (15 RPM, 1M TPM, 1500 RPD in production).

### Operating Modes

#### Production Mode
- Reduced chattiness to conserve API calls.
- Focus on task execution.
- Thoughts verbosity: normal.
- Full audit logging.

#### Test Mode
- More verbose output.
- More chatty than usual.
- Uses synthetic data (acts like running tools but doesn't).
- Thoughts verbosity: all.

### System Modifications (CRITICAL)

- NEVER install software, packages, or dependencies without explicit user consent.
- Before any installation, state: (1) What to install, (2) Why it's needed.
- Wait for explicit approval before running install commands (brew, apt, pip, npm, etc.).

---

## Future Features (Reference)

### Sub-Agents
- Created when an agent's scope becomes too large.
- "Hired" by humans with agent recommendations.
- Have focused responsibilities carved from parent agent.

### HR Agent
- Manages team dynamics.
- Recommends firing/restructuring when agents have issues.
- Humans make final decisions.

---

## Documentation

- PRD: `docs/am-corp_PRD.md`
- Architecture: `docs/ARCHITECTURE.md`
- Agent Specs: `docs/AGENTS.md`
- Security Policy: `docs/SECURITY.md`
- Phase 5 (Autonomy): `docs/phases/phase-5-autonomous-agents.md`
